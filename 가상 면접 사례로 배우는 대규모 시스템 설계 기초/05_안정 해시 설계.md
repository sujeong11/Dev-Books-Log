💡 수평적 규모 확장성을 달성하기 위해서는 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요하다. 안정 해시는 이 목표를 달설하기 위해 보편적으로 사용하는 기술이다.

<br>
<br>
<br>

## [1] 해시 키 재배치(rehash) 문제

- N개의 캐시 서버가 있다고 하자.
- 이 서버들에게 부하를 균등하게 나누는 보편적 방법은 아래의 해시 함수를 사용하는 것이다.
    - serverIndex = `hash(key) % N` (N=서버개수)
- 위 해시 함수를 사용하면 ***서버의 개수가 고정적일 때는 데이터가 균등하게 잘 분포***되어 있다.
- 하지만, **여러 서버 중 한 대의 서버가 장애가 발생해 동작을 중단**하게 되면 **N의 값이 달라지고 serverIndex 값도 달라진다.** 그래서 데이터가 다시 재분배되면서 **캐시 클라이언트가 데이터가 없는 엉뚱한 서버에 접속하게 되는 문제가 발생**한다.

<br>
<br>
<br>

## [2] 안정해시

> 헤시 테이블 크기가 조정될 때 평균적으로 오직 k/n개의 키만 재배치하는 해시 기술 (k=키의 개수, n=슬롯의 개수)
> 
- 이와 달리 대부분의 전통적 해시 테이블은 슬롯의 수가 바뀌면 거의 대부분 키를 재배치 한다.

### 해시 공간과 해시 링

- ***해시 공간***
    - 해시 함수를 SHA-1를 사용한다고 하면 해시 공간 범위는 `0 ~ 2^160 - 1`까지 이다.
- ***해시 링***: 해시 공간의 양쪽을 구부려 접은 것

### 해시 서버

- 해시 함수 f를 사용하면 서버 IP나 이름을 해시 링 위의 어떤 위치에 대응시킬 수 있다.

### 해시 키

- 여기 사용돤 해시 함수는 “해시 키 재배치 문제”에 언급된 함수와는 다르며, `나머지 연산 %는 사용하지 않고 있음에 유의`하자.

### 서버 조회

- 어떤 키가 저장되는 서버는, 해당 키의 위치로부터 ***시계 방향으로 링을 탐색해나가면서 만나는 첫 번째 서버***다.

### 서버 추가

- 서버가 추가하더라도 키 가운데 `일부만 재배치`하면 된다.
- 즉, **key들 중 새로운 서버와 가장 가까이 위치하게 된 것들만 재배치**한다.

### 서버 제거

- 하나의 서버가 제거되면 키 가운데 일부만 재배치된다.
- 즉, **삭제된 서버에 위치하던 key들만 시계방향에서 가까운 서버에 위치하도록 재배치**한다.

### 기본 구현법의 두 가지 문제

1. **서버가 추가되거나 삭제되는 상황을 감안하면 파티션의 크기를 균등하게 유지하는게 불가능**하다는 것
    1. 여기서 파티션은 인접한 서버 사이의 해시 공간
    2. 즉, 어떤 서버는 굉장히 작은 해시 공간을 할당 받고, 어떤 서버는 굉장히 큰 해시 공간을 할당 받는 상황이 가능하다는 것
2. **키의 균등배포를 달성하기 어렵다는 것**
    1. 서버 3에는 아무 데이터도 갖지 않는 반면, 서버 2에 대부분의 키가 보관되는 상황이 가능하다는 것
- [ 해결 ] `가상 노드` or `복제`

### 가상 노드

> 실제 노드 또는 서버를 가리키는 노드로서, 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있다.
> 
- 예시
    - 서버 0과 서버 1은 3개의 가상 노드를 갖는다. (여기서 숫자 3은 임의의 숫자로 실제 시스템에서는 그보다 훨씬 큰 값을 사용함)
    - 서버 0을 링에 배치하기 위해 s0 하나만 쓰는 대신, s0_0, s0_1, s0_2의 세 개의 가상 노드 사용한다. 마찬가지로 서버 1도 s1_0, s1_1, s1_2의 세 개의 사상 노드를 사용한다,
    - 따라서 각 서버는 하나가 아닌 여러 개 파티션을 관리해야 한다.
    - (링은 `s0_0 → s1_0 → s0_1 → s1_1 → s0_2 → s1_2`)
    - **키의 위치로부터 시계 방향으로 링을 탐색하다 만나는 최초의 가상 노드가 해당 키가 저장될 서버가 된다.**
    - (그림 5-12, 13 참고)
    
- `가상 노드의 개수를 늘리면 키의 분포는 점점 더 균등`해진다. 하지만, **가상 노드 데이터를 저장할 공간은 더 많이 필요하게 될 것**이다.
- 즉, 타협적 결정이 필요하다.

<br>
<br>
<br>

## [3] 마치며

- 안정적 해시 이점
    - 서버가 추가/삭제 될 때 **재배치되는 키의 수 최소화**
    - **데이터가 보다 균등하게 분포** → 수평적 규모 확장성을 달성하기 쉬움
    - 핫스팟 키 문제를 줄인다. **특정한 샤드에 대한 접근이 지나치게 빈번하면 서버 과부하 문제가 생길 수 있는데 데이터를 좀 더 균등하게 분배하므로 이런 문제가 생길 가능성을 줄인다.**
